{"ast":null,"code":"import React, { useEffect, useRef, useState, useContext } from 'react';\nimport PropTypes from 'prop-types';\nimport StartAudioContext from 'startaudiocontext';\nimport Tone from 'tone';\nimport equal from 'fast-deep-equal';\nvar SongContext = /*#__PURE__*/React.createContext({\n  isPlaying: false\n});\n\nvar Song = function Song(_ref) {\n  var _ref$isPlaying = _ref.isPlaying,\n      isPlaying = _ref$isPlaying === void 0 ? false : _ref$isPlaying,\n      _ref$bpm = _ref.bpm,\n      bpm = _ref$bpm === void 0 ? 90 : _ref$bpm,\n      _ref$swing = _ref.swing,\n      swing = _ref$swing === void 0 ? 0 : _ref$swing,\n      _ref$swingSubdivision = _ref.swingSubdivision,\n      swingSubdivision = _ref$swingSubdivision === void 0 ? '8n' : _ref$swingSubdivision,\n      _ref$volume = _ref.volume,\n      volume = _ref$volume === void 0 ? 0 : _ref$volume,\n      _ref$isMuted = _ref.isMuted,\n      isMuted = _ref$isMuted === void 0 ? false : _ref$isMuted,\n      children = _ref.children;\n  useEffect(function () {\n    document.body.addEventListener('click', function () {\n      // iOS Web Audio API requires this library.\n      StartAudioContext(Tone.context);\n    }, {\n      once: true\n    });\n  }, []);\n  useEffect(function () {\n    Tone.Transport.bpm.value = bpm;\n    Tone.Transport.swing = swing;\n    Tone.Transport.swingSubdivision = swingSubdivision;\n  }, [bpm, swing, swingSubdivision]);\n  useEffect(function () {\n    if (isPlaying) {\n      // Hack to get Tone to NOT use same settings from another instance\n      Tone.Transport.bpm.value = bpm;\n      Tone.Transport.swing = swing;\n      Tone.Transport.swingSubdivision = swingSubdivision;\n      Tone.Transport.start();\n    } else {\n      Tone.Transport.stop();\n    }\n  }, [isPlaying]);\n  useEffect(function () {\n    Tone.Master.volume.value = volume;\n  }, [volume]);\n  useEffect(function () {\n    Tone.Master.mute = isMuted;\n  }, [isMuted]);\n\n  if (typeof window === 'undefined') {\n    return null;\n  }\n\n  return React.createElement(SongContext.Provider, {\n    value: {\n      isPlaying: isPlaying\n    }\n  }, children);\n};\n\nSong.propTypes = {\n  isPlaying: PropTypes.bool,\n  bpm: PropTypes.number,\n  swing: PropTypes.number,\n  swingSubdivision: /*#__PURE__*/PropTypes.oneOf(['8n']),\n  children: PropTypes.node\n};\nvar instruments = [{\n  id: 'amSynth',\n  name: 'AM Synth',\n  props: ['polyphony', 'oscillatorType']\n}, {\n  id: 'duoSynth',\n  name: 'Duo Synth',\n  props: ['polyphony', 'oscillatorType']\n}, {\n  id: 'fmSynth',\n  name: 'FM Synth',\n  props: ['polyphony', 'oscillatorType']\n}, {\n  id: 'membraneSynth',\n  name: 'Membrane Synth',\n  props: []\n}, {\n  id: 'metalSynth',\n  name: 'Metal Synth',\n  props: []\n}, {\n  id: 'monoSynth',\n  name: 'Mono Synth',\n  props: ['polyphony', 'oscillatorType']\n}, // { id: 'noiseSynth', name: 'Noise Synth' }, // No sound, disabled for now\n{\n  id: 'pluckSynth',\n  name: 'Pluck Synth',\n  props: []\n}, {\n  id: 'sampler',\n  name: 'Sampler',\n  props: ['samples']\n}, {\n  id: 'synth',\n  name: 'Synth',\n  props: ['polyphony', 'oscillatorType']\n}];\nvar effects = [// --------------------------------------------------------------------------\n// Tone JS Effects\n// --------------------------------------------------------------------------\n{\n  id: 'autoFilter',\n  name: 'Auto Filter'\n}, {\n  id: 'autoPanner',\n  name: 'Auto Panner'\n}, {\n  id: 'autoWah',\n  name: 'Auto Wah'\n}, {\n  id: 'bitCrusher',\n  name: 'Bit Crusher'\n}, // { id: 'chorus', name: 'Chorus' },\n{\n  id: 'distortion',\n  name: 'Distortion'\n}, {\n  id: 'feedbackDelay',\n  name: 'Feedback Delay'\n}, {\n  id: 'freeverb',\n  name: 'Freeverb'\n}, {\n  id: 'panVol',\n  name: 'Volume/Pan'\n}, // { id: 'reverb', name: 'Reverb' },\n{\n  id: 'tremolo',\n  name: 'Tremolo'\n}, // --------------------------------------------------------------------------\n// Tone JS Components\n// --------------------------------------------------------------------------\n{\n  id: 'eq3',\n  name: 'EQ3'\n}];\nvar config = {\n  instruments: instruments,\n  effects: effects\n};\nvar NoteType = /*#__PURE__*/PropTypes.shape({\n  name: PropTypes.string.isRequired,\n  duration: /*#__PURE__*/PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n  velocity: PropTypes.number\n});\nvar StepNoteType = /*#__PURE__*/PropTypes.shape({\n  name: /*#__PURE__*/PropTypes.oneOfType([NoteType, PropTypes.string]),\n  duration: /*#__PURE__*/PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n  velocity: PropTypes.number\n});\nvar StepType = /*#__PURE__*/PropTypes.oneOfType([StepNoteType, /*#__PURE__*/PropTypes.arrayOf(StepNoteType), /*#__PURE__*/PropTypes.arrayOf(PropTypes.string), PropTypes.string]);\nvar InstrumentTypes = /*#__PURE__*/PropTypes.oneOf( /*#__PURE__*/instruments.map(function (effect) {\n  return effect.id;\n}));\nvar EffectTypes = /*#__PURE__*/PropTypes.oneOf( /*#__PURE__*/effects.map(function (effect) {\n  return effect.id;\n}));\n\nfunction buildSequencerStep(step, i) {\n  if (typeof step === 'string') {\n    return {\n      notes: [{\n        name: step\n      }],\n      index: i\n    };\n  } else if (step && step.name) {\n    return {\n      notes: [{\n        name: step.name,\n        duration: step.duration,\n        velocity: step.velocity\n      }],\n      index: i\n    };\n  } else if (Array.isArray(step)) {\n    return {\n      notes: step.map(function (s) {\n        if (typeof s === 'string') {\n          return {\n            name: s\n          };\n        }\n\n        return s;\n      }),\n      index: i\n    };\n  }\n\n  return {\n    notes: [],\n    index: i\n  };\n}\n\nfunction usePrevious(value) {\n  // The ref object is a generic container whose current property is mutable ...\n  // ... and can hold any value, similar to an instance property on a class\n  var ref = useRef(); // Store current value in ref\n\n  useEffect(function () {\n    ref.current = value;\n  }, [value]); // Only re-run if value changes\n  // Return previous value (happens before update in useEffect above)\n\n  return ref.current;\n}\n\nvar TrackContext = /*#__PURE__*/React.createContext({\n  volume: 0,\n  pan: 0,\n  mute: false,\n  solo: false,\n  effectsChain: null,\n  onInstrumentsUpdate: null,\n  onAddToEffectsChain: null,\n  onRemoveFromEffectsChain: null\n});\n\nvar TrackConsumer = function TrackConsumer(_ref) {\n  var isPlaying = _ref.isPlaying,\n      _ref$steps = _ref.steps,\n      steps = _ref$steps === void 0 ? [] : _ref$steps,\n      _ref$volume = _ref.volume,\n      volume = _ref$volume === void 0 ? 0 : _ref$volume,\n      _ref$pan = _ref.pan,\n      pan = _ref$pan === void 0 ? 0 : _ref$pan,\n      mute = _ref.mute,\n      solo = _ref.solo,\n      _ref$subdivision = _ref.subdivision,\n      subdivision = _ref$subdivision === void 0 ? '4n' : _ref$subdivision,\n      _ref$effects = _ref.effects,\n      effects = _ref$effects === void 0 ? [] : _ref$effects,\n      children = _ref.children,\n      onStepPlay = _ref.onStepPlay;\n\n  var _useState = useState([]),\n      effectsChain = _useState[0],\n      setEffectsChain = _useState[1];\n\n  var _useState2 = useState([]),\n      instruments = _useState2[0],\n      setInstruments = _useState2[1];\n\n  var sequencer = useRef();\n  var instrumentsRef = useRef(instruments);\n  useEffect(function () {\n    instrumentsRef.current = instruments;\n  }, [instruments]);\n  /*\r\n  Tone.Sequence can't easily play chords. By default, arrays within steps are flattened out and subdivided. However an array of notes is our preferred way of representing chords. To get around this, buildSequencerStep() will transform notes and put them in a notes field as an array. We can then loop through and run triggerAttackRelease() to play the note/s.\r\n  */\n\n  var sequencerSteps = steps.map(buildSequencerStep);\n  var prevSequencerSteps = usePrevious(sequencerSteps);\n  useEffect(function () {\n    // -------------------------------------------------------------------------\n    // STEPS\n    // -------------------------------------------------------------------------\n    // Start/Stop sequencer!\n    if (isPlaying) {\n      var _sequencer$current;\n\n      sequencer.current = new Tone.Sequence(function (_, step) {\n        step.notes.forEach(function (note) {\n          instrumentsRef.current.map(function (instrument) {\n            instrument.triggerAttackRelease(note.name, note.duration || 0.5, undefined, note.velocity);\n          });\n        });\n\n        if (typeof onStepPlay === 'function') {\n          onStepPlay(step.notes, step.index);\n        }\n      }, sequencerSteps, subdivision);\n      (_sequencer$current = sequencer.current) === null || _sequencer$current === void 0 ? void 0 : _sequencer$current.start(0);\n    } else {\n      if (sequencer.current) {\n        sequencer.current.stop();\n      }\n    }\n  }, [isPlaying]);\n  useEffect(function () {\n    if (sequencer.current) {\n      // const isEqual = equal(steps.notes, prevSequencerSteps[i].notes);\n      sequencerSteps.forEach(function (step, i) {\n        var isEqual = equal(sequencerSteps[i].notes, prevSequencerSteps && prevSequencerSteps[i] ? prevSequencerSteps[i].notes : []);\n\n        if (!isEqual) {\n          var _sequencer$current2, _sequencer$current3;\n\n          (_sequencer$current2 = sequencer.current) === null || _sequencer$current2 === void 0 ? void 0 : _sequencer$current2.remove(i);\n          (_sequencer$current3 = sequencer.current) === null || _sequencer$current3 === void 0 ? void 0 : _sequencer$current3.add(i, step);\n        }\n      });\n    }\n  }, [JSON.stringify(sequencerSteps)]);\n  useEffect(function () {\n    return function cleanup() {\n      if (sequencer.current) {\n        sequencer.current.dispose();\n      }\n    };\n  }, []);\n\n  var handleAddToEffectsChain = function handleAddToEffectsChain(effect) {\n    // console.log('<Track />', 'onAddToEffectsChain');\n    setEffectsChain(function (prevEffectsChain) {\n      return [effect].concat(prevEffectsChain);\n    });\n  };\n\n  var handleRemoveFromEffectsChain = function handleRemoveFromEffectsChain(effect) {\n    // console.log('<Track />', 'onRemoveFromEffectsChain', effect);\n    setEffectsChain(function (prevEffectsChain) {\n      return prevEffectsChain.filter(function (e) {\n        return e.id !== effect.id;\n      });\n    });\n  };\n\n  var handleInstrumentsUpdate = function handleInstrumentsUpdate(newInstruments) {\n    setInstruments(newInstruments);\n  };\n\n  return React.createElement(TrackContext.Provider, {\n    value: {\n      effectsChain: effectsChain,\n      pan: pan,\n      volume: volume,\n      mute: mute,\n      solo: solo,\n      onInstrumentsUpdate: handleInstrumentsUpdate,\n      onAddToEffectsChain: handleAddToEffectsChain,\n      onRemoveFromEffectsChain: handleRemoveFromEffectsChain\n    }\n  }, children, effects);\n};\n\nTrackConsumer.propTypes = {\n  // <Song /> props\n  isPlaying: PropTypes.bool,\n  // <Track /> props\n  // @ts-ignore\n  steps: /*#__PURE__*/PropTypes.arrayOf(StepType),\n  volume: PropTypes.number,\n  pan: PropTypes.number,\n  mute: PropTypes.bool,\n  solo: PropTypes.bool,\n  subdivision: PropTypes.string,\n  // effects: PropTypes.oneOfType([\n  //   PropTypes.node,\n  //   PropTypes.arrayOf(PropTypes.element),\n  // ]),\n  onStepPlay: PropTypes.func\n};\n\nvar Track = function Track(props) {\n  var _React$useContext = React.useContext(SongContext),\n      isPlaying = _React$useContext.isPlaying;\n\n  if (typeof window === 'undefined') {\n    return null;\n  }\n\n  return React.createElement(TrackConsumer, Object.assign({\n    isPlaying: isPlaying\n  }, props));\n};\n\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n\n    return target;\n  };\n\n  return _extends.apply(this, arguments);\n}\n\nvar InstrumentConsumer = function InstrumentConsumer(_ref) {\n  var _ref$type = _ref.type,\n      type = _ref$type === void 0 ? 'synth' : _ref$type,\n      options = _ref.options,\n      _ref$polyphony = _ref.polyphony,\n      polyphony = _ref$polyphony === void 0 ? 4 : _ref$polyphony,\n      oscillator = _ref.oscillator,\n      envelope = _ref.envelope,\n      _ref$notes = _ref.notes,\n      notes = _ref$notes === void 0 ? [] : _ref$notes,\n      samples = _ref.samples,\n      onLoad = _ref.onLoad,\n      volume = _ref.volume,\n      pan = _ref.pan,\n      mute = _ref.mute,\n      solo = _ref.solo,\n      effectsChain = _ref.effectsChain,\n      onInstrumentsUpdate = _ref.onInstrumentsUpdate;\n  var instrumentRef = useRef(); // const trackChannelBase = useRef(new Tone.PanVol(pan, volume));\n  // const trackChannelBase = useRef(new Tone.Channel(volume, pan));\n\n  var trackChannelBase = useRef(null);\n  var prevNotes = usePrevious(notes); // -------------------------------------------------------------------------\n  // CHANNEL\n  // TODO: Consider moving this to <Track>\n  // -------------------------------------------------------------------------\n\n  useEffect(function () {\n    trackChannelBase.current = new Tone.Channel(volume, pan);\n    return function cleanup() {\n      if (trackChannelBase.current) {\n        trackChannelBase.current.dispose();\n      }\n    };\n  }, []); // -------------------------------------------------------------------------\n  // INSTRUMENT TYPE\n  // -------------------------------------------------------------------------\n\n  useEffect(function () {\n    var _instrumentRef$curren;\n\n    if (type === 'sampler') {\n      instrumentRef.current = new Tone.Sampler(samples, onLoad);\n\n      if (options && options.curve) {\n        instrumentRef.current.curve = options.curve;\n      }\n\n      if (options && options.release) {\n        instrumentRef.current.release = options.release;\n      }\n    } else if (type === 'membraneSynth') {\n      instrumentRef.current = new Tone.MembraneSynth(buildSynthOptions({\n        oscillator: oscillator,\n        envelope: envelope\n      }));\n    } else if (type === 'metalSynth') {\n      instrumentRef.current = new Tone.MetalSynth();\n    } else if (type === 'noiseSynth') {\n      instrumentRef.current = new Tone.NoiseSynth();\n    } else if (type === 'pluckSynth') {\n      instrumentRef.current = new Tone.PluckSynth();\n    } else {\n      var synth;\n\n      if (type === 'amSynth') {\n        synth = Tone.AMSynth;\n      } else if (type === 'duoSynth') {\n        synth = Tone.DuoSynth;\n      } else if (type === 'fmSynth') {\n        synth = Tone.FMSynth;\n      } else if (type === 'monoSynth') {\n        synth = Tone.MonoSynth;\n      } else if (type === 'synth') {\n        synth = Tone.Synth;\n      } else {\n        synth = Tone.Synth;\n      }\n      /**\r\n       * PolySynth accepts other Synth types as second param, making them\r\n       * polyphonic. As this is a common use case, all Synths will be created\r\n       * via PolySynth. Monophonic synths can easily be created by setting the\r\n       * `polyphony` prop to 1.\r\n       */\n\n\n      instrumentRef.current = new Tone.PolySynth(polyphony, synth, buildSynthOptions({\n        oscillator: oscillator,\n        envelope: envelope\n      }));\n    }\n\n    (_instrumentRef$curren = instrumentRef.current).chain.apply(_instrumentRef$curren, effectsChain.concat([trackChannelBase.current, Tone.Master])); // Add this Instrument to Track Context\n\n\n    onInstrumentsUpdate([instrumentRef.current]);\n    return function cleanup() {\n      if (instrumentRef.current) {\n        instrumentRef.current.dispose();\n      }\n    };\n  }, [type, polyphony]);\n  useEffect(function () {\n    if ( // TODO: Add other synth types\n    type === 'synth' && instrumentRef && instrumentRef.current && oscillator) {\n      instrumentRef.current.set('oscillator', oscillator); // console.log(oscillator);\n    }\n  }, [oscillator, type]); // -------------------------------------------------------------------------\n  // VOLUME / PAN / MUTE / SOLO\n  // -------------------------------------------------------------------------\n\n  useEffect(function () {\n    trackChannelBase.current.volume.value = volume;\n  }, [volume]);\n  useEffect(function () {\n    trackChannelBase.current.pan.value = pan;\n  }, [pan]);\n  useEffect(function () {\n    trackChannelBase.current.mute = mute;\n  }, [mute]);\n  useEffect(function () {\n    trackChannelBase.current.solo = solo;\n  }, [solo]); // -------------------------------------------------------------------------\n  // NOTES\n  // -------------------------------------------------------------------------\n\n  /**\r\n   NOTE: Would prefer to use useLayoutEffect as it is a little faster, but unable to test it right now\r\n   **/\n\n  useEffect(function () {\n    // Loop through all current notes\n    notes && notes.forEach(function (note) {\n      // Check if note is playing\n      var isPlaying = prevNotes && prevNotes.filter(function (prevNote) {\n        // Check both note name and unique key.\n        // Key helps differentiate same notes, otherwise it won't trigger\n        return prevNote.name === note.name && prevNote.key === note.key;\n      }).length > 0; // Only play note is it isn't already playing\n\n      if (!isPlaying) {\n        if (note.duration) {\n          instrumentRef.current.triggerAttackRelease(note.name, note.duration, undefined, note.velocity);\n        } else {\n          instrumentRef.current.triggerAttack(note.name, undefined, note.velocity);\n        }\n      }\n    }); // Loop through all previous notes\n\n    prevNotes && prevNotes.forEach(function (note) {\n      // Check if note is still playing\n      var isPlaying = notes && notes.filter(function (n) {\n        return n.name === note.name;\n      }).length > 0;\n\n      if (!isPlaying) {\n        instrumentRef.current.triggerRelease(note.name);\n      }\n    });\n  }, [notes, prevNotes]); // -------------------------------------------------------------------------\n  // EFFECTS CHAIN\n  // -------------------------------------------------------------------------\n\n  useEffect(function () {\n    var _instrumentRef$curren2; // NOTE: Using trackChannelBase causes effects to not turn off\n\n\n    instrumentRef.current.disconnect();\n\n    (_instrumentRef$curren2 = instrumentRef.current).chain.apply(_instrumentRef$curren2, effectsChain.concat([trackChannelBase.current, Tone.Master]));\n  }, [effectsChain]); // -------------------------------------------------------------------------\n  // SAMPLES\n  // Run whenever `samples` change, using Tone.Sampler's `add` method to load\n  // more samples after initial mount\n  // -------------------------------------------------------------------------\n\n  useEffect(function () {\n    if (type === 'sampler' && typeof onLoad === 'function' && Boolean(samples)) {\n      // Create an array of promises from `samples`\n      var loadSamplePromises = Object.keys(samples).map(function (key) {\n        return new Promise(function (resolve) {\n          var sample = samples[key]; // Pass `resolve` to `onLoad` parameter of Tone.Sampler\n          // When sample loads, this promise will resolve\n\n          instrumentRef.current.add(key, sample, resolve);\n        });\n      }); // Once all promises in array resolve, run onLoad callback\n\n      Promise.all(loadSamplePromises).then(function (event) {\n        onLoad(event);\n      });\n    }\n  }, [samples, type]);\n  return null;\n};\n\nInstrumentConsumer.propTypes = {\n  // <Instrument /> Props\n  // @ts-ignore\n  type: InstrumentTypes.isRequired,\n  options: PropTypes.object,\n  // @ts-ignore\n  notes: /*#__PURE__*/PropTypes.arrayOf(NoteType),\n  polyphony: PropTypes.number,\n  envelope: /*#__PURE__*/PropTypes.shape({\n    attack: PropTypes.number,\n    decay: PropTypes.number,\n    sustain: PropTypes.number,\n    release: PropTypes.number\n  }),\n  // oscillator: PropTypes.shape({\n  //   type: PropTypes.oneOf(['triangle', 'sine', 'square']),\n  // }),\n  // @ts-ignore\n  samples: PropTypes.object,\n  // trackChannel: PropTypes.object, // An instance of new this.Tone.PanVol()\n  // <Track /> Props\n  volume: PropTypes.number,\n  pan: PropTypes.number,\n  mute: PropTypes.bool,\n  solo: PropTypes.bool,\n  effectsChain: PropTypes.array,\n  onInstrumentsUpdate: PropTypes.func\n};\n\nvar Instrument = function Instrument(_ref2) {\n  var type = _ref2.type,\n      options = _ref2.options,\n      notes = _ref2.notes,\n      polyphony = _ref2.polyphony,\n      oscillator = _ref2.oscillator,\n      envelope = _ref2.envelope,\n      samples = _ref2.samples,\n      onLoad = _ref2.onLoad;\n\n  var _useContext = useContext(TrackContext),\n      volume = _useContext.volume,\n      pan = _useContext.pan,\n      mute = _useContext.mute,\n      solo = _useContext.solo,\n      effectsChain = _useContext.effectsChain,\n      onInstrumentsUpdate = _useContext.onInstrumentsUpdate;\n\n  if (typeof window === 'undefined') {\n    return null;\n  }\n\n  return React.createElement(InstrumentConsumer // <Instrument /> Props\n  , {\n    // <Instrument /> Props\n    type: type,\n    options: options,\n    notes: notes,\n    polyphony: polyphony,\n    oscillator: oscillator,\n    envelope: envelope,\n    samples: samples,\n    onLoad: onLoad,\n    // <Track /> Props\n    volume: volume,\n    pan: pan,\n    mute: mute,\n    solo: solo,\n    effectsChain: effectsChain,\n    onInstrumentsUpdate: onInstrumentsUpdate\n  });\n};\n/**\r\n * Use Instrument's flattened synth props to create options object for Tone JS\r\n */\n\n\nvar buildSynthOptions = function buildSynthOptions(_ref3) {\n  var oscillator = _ref3.oscillator,\n      envelope = _ref3.envelope;\n\n  if (oscillator || envelope) {\n    return _extends({}, envelope ? {\n      envelope: envelope\n    } : {}, {}, oscillator ? {\n      oscillator: oscillator\n    } : {});\n  }\n\n  return undefined;\n};\n\nvar EffectConsumer = function EffectConsumer(_ref) {\n  var type = _ref.type,\n      id = _ref.id,\n      _ref$delayTime = _ref.delayTime,\n      delayTime = _ref$delayTime === void 0 ? '8n' : _ref$delayTime,\n      _ref$feedback = _ref.feedback,\n      feedback = _ref$feedback === void 0 ? 0.5 : _ref$feedback,\n      _ref$wet = _ref.wet,\n      wet = _ref$wet === void 0 ? 1 : _ref$wet,\n      low = _ref.low,\n      mid = _ref.mid,\n      high = _ref.high,\n      lowFrequency = _ref.lowFrequency,\n      highFrequency = _ref.highFrequency,\n      onAddToEffectsChain = _ref.onAddToEffectsChain,\n      onRemoveFromEffectsChain = _ref.onRemoveFromEffectsChain;\n  var effect = useRef();\n  useEffect(function () {\n    // console.log('<Effect /> mount');\n    // console.log(`id: ${id}`);\n    if (type === 'autoFilter') {\n      effect.current = new Tone.AutoFilter();\n    } else if (type === 'autoPanner') {\n      effect.current = new Tone.AutoPanner();\n    } else if (type === 'autoWah') {\n      effect.current = new Tone.AutoWah();\n    } else if (type === 'bitCrusher') {\n      effect.current = new Tone.BitCrusher(); // Removed for now because delayTime has to be in ms\n      // } else if (type === 'chorus') {\n      //   effect.current = new Tone.Chorus();\n    } else if (type === 'distortion') {\n      effect.current = new Tone.Distortion(0.5);\n    } else if (type === 'feedbackDelay') {\n      effect.current = new Tone.FeedbackDelay(delayTime, feedback);\n    } else if (type === 'freeverb') {\n      effect.current = new Tone.Freeverb();\n    } else if (type === 'panVol') {\n      effect.current = new Tone.PanVol(); // Needs generate()\n      // } else if (type === 'reverb') {\n      //   effect.current = new Tone.Reverb();\n    } else if (type === 'tremolo') {\n      effect.current = new Tone.Tremolo();\n    } else if (type === 'eq3') {\n      effect.current = new Tone.EQ3(low, mid, high);\n    }\n\n    if (effect.current) {\n      effect.current.id = id; // Update effects chain\n      // TODO: Work out which index to insert current this.effect\n\n      onAddToEffectsChain(effect.current);\n    }\n\n    return function () {\n      // console.log('<Effect /> unmount');\n      onRemoveFromEffectsChain(effect.current);\n    };\n  }, [type]);\n  useEffect(function () {\n    if (effect.current && effect.current.feedback) {\n      effect.current.feedback.value = feedback;\n    }\n  }, [feedback]);\n  useEffect(function () {\n    if (effect.current && effect.current.delayTime) {\n      effect.current.delayTime.value = delayTime;\n    }\n  }, [delayTime]);\n  useEffect(function () {\n    if (effect.current && effect.current.wet) {\n      effect.current.wet.value = wet;\n    }\n  }, [wet]);\n  useEffect(function () {\n    if (typeof low !== 'undefined' && effect.current && effect.current.low) {\n      effect.current.low.value = low;\n    }\n  }, [low]);\n  useEffect(function () {\n    if (typeof mid !== 'undefined' && effect.current && effect.current.mid) {\n      effect.current.mid.value = mid;\n    }\n  }, [mid]);\n  useEffect(function () {\n    if (typeof high !== 'undefined' && effect.current && effect.current.high) {\n      effect.current.high.value = high;\n    }\n  }, [high]);\n  useEffect(function () {\n    if (typeof lowFrequency !== 'undefined' && effect.current && effect.current.lowFrequency) {\n      effect.current.lowFrequency.value = lowFrequency;\n    }\n  }, [lowFrequency]);\n  useEffect(function () {\n    if (typeof highFrequency !== 'undefined' && effect.current && effect.current.highFrequency) {\n      effect.current.highFrequency.value = highFrequency;\n    }\n  }, [highFrequency]);\n  return null;\n};\n\nEffectConsumer.propTypes = {\n  // @ts-ignore\n  type: EffectTypes.isRequired,\n  // @ts-ignore\n  id: /*#__PURE__*/PropTypes.oneOfType([PropTypes.string.isRequired, PropTypes.number.isRequired]),\n  delayTime: PropTypes.string,\n  feedback: PropTypes.number,\n  wet: PropTypes.number,\n  low: PropTypes.number,\n  mid: PropTypes.number,\n  high: PropTypes.number,\n  lowFrequency: PropTypes.number,\n  highFrequency: PropTypes.number,\n  // <Track /> Props\n  onAddToEffectsChain: PropTypes.func,\n  onRemoveFromEffectsChain: PropTypes.func\n};\n\nvar Effect = function Effect(props) {\n  var _useContext = useContext(TrackContext),\n      onAddToEffectsChain = _useContext.onAddToEffectsChain,\n      onRemoveFromEffectsChain = _useContext.onRemoveFromEffectsChain;\n\n  return React.createElement(EffectConsumer, Object.assign({\n    onAddToEffectsChain: onAddToEffectsChain,\n    onRemoveFromEffectsChain: onRemoveFromEffectsChain\n  }, props));\n};\n\nexport { Effect, Instrument, Song, Track, config };","map":{"version":3,"sources":["../src/components/Song.tsx","../src/config/index.ts","../src/types/propTypes.ts","../src/lib/buildSequencerStep.ts","../src/lib/hooks/index.ts","../src/components/Track.tsx","../src/components/Instrument.tsx","../src/components/Effect.tsx"],"names":["SongContext","isPlaying","Song","bpm","swing","swingSubdivision","volume","isMuted","children","useEffect","document","StartAudioContext","Tone","once","value","PropTypes","node","instruments","id","name","props","effects","config","NoteType","duration","velocity","number","StepNoteType","StepType","InstrumentTypes","effect","EffectTypes","buildSequencerStep","step","i","notes","index","Array","s","usePrevious","ref","useRef","TrackContext","pan","mute","solo","effectsChain","onInstrumentsUpdate","onAddToEffectsChain","onRemoveFromEffectsChain","TrackConsumer","steps","subdivision","onStepPlay","setEffectsChain","useState","setInstruments","sequencer","instrumentsRef","sequencerSteps","prevSequencerSteps","instrument","note","isEqual","equal","JSON","handleAddToEffectsChain","handleRemoveFromEffectsChain","e","handleInstrumentsUpdate","func","Track","React","InstrumentConsumer","type","options","polyphony","oscillator","envelope","samples","onLoad","instrumentRef","trackChannelBase","prevNotes","buildSynthOptions","synth","prevNote","n","Boolean","loadSamplePromises","sample","Promise","attack","decay","sustain","release","Instrument","useContext","EffectConsumer","delayTime","feedback","wet","low","mid","high","lowFrequency","highFrequency","Effect"],"mappings":"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","sourcesContent":["import React, { useEffect } from 'react';\nimport PropTypes from 'prop-types';\nimport StartAudioContext from 'startaudiocontext';\n\nimport Tone from '../lib/tone';\n\ntype SongContextProps = {\n  isPlaying: boolean;\n};\n\nexport const SongContext = React.createContext<SongContextProps>({\n  isPlaying: false,\n});\n\nexport type SongProps = {\n  isPlaying?: boolean;\n  bpm?: number;\n  swing?: number;\n  subdivision?: string;\n  swingSubdivision?: string;\n  volume?: number;\n  isMuted?: boolean;\n  children: React.ReactNode;\n};\n\nconst Song: React.FC<SongProps> = ({\n  isPlaying = false,\n  bpm = 90,\n  // subdivision = '4n',\n  swing = 0,\n  swingSubdivision = '8n',\n  volume = 0,\n  isMuted = false,\n  children,\n}) => {\n  useEffect(() => {\n    document.body.addEventListener(\n      'click',\n      () => {\n        // iOS Web Audio API requires this library.\n        StartAudioContext(Tone.context);\n      },\n      {\n        once: true,\n      },\n    );\n  }, []);\n\n  useEffect(() => {\n    Tone.Transport.bpm.value = bpm;\n    Tone.Transport.swing = swing;\n    Tone.Transport.swingSubdivision = swingSubdivision;\n  }, [bpm, swing, swingSubdivision]);\n\n  useEffect(() => {\n    if (isPlaying) {\n      // Hack to get Tone to NOT use same settings from another instance\n      Tone.Transport.bpm.value = bpm;\n      Tone.Transport.swing = swing;\n      Tone.Transport.swingSubdivision = swingSubdivision;\n\n      Tone.Transport.start();\n    } else {\n      Tone.Transport.stop();\n    }\n  }, [isPlaying]);\n\n  useEffect(() => {\n    Tone.Master.volume.value = volume;\n  }, [volume]);\n\n  useEffect(() => {\n    Tone.Master.mute = isMuted;\n  }, [isMuted]);\n\n  if (typeof window === 'undefined') {\n    return null;\n  }\n\n  return (\n    <SongContext.Provider\n      value={{\n        isPlaying,\n      }}\n    >\n      {children}\n    </SongContext.Provider>\n  );\n};\n\nSong.propTypes = {\n  isPlaying: PropTypes.bool,\n  bpm: PropTypes.number,\n  swing: PropTypes.number,\n  swingSubdivision: PropTypes.oneOf(['8n']),\n  children: PropTypes.node,\n};\n\nexport default Song;\n","export const instruments = [\n  { id: 'amSynth', name: 'AM Synth', props: ['polyphony', 'oscillatorType'] },\n  { id: 'duoSynth', name: 'Duo Synth', props: ['polyphony', 'oscillatorType'] },\n  { id: 'fmSynth', name: 'FM Synth', props: ['polyphony', 'oscillatorType'] },\n  { id: 'membraneSynth', name: 'Membrane Synth', props: [] },\n  { id: 'metalSynth', name: 'Metal Synth', props: [] },\n  {\n    id: 'monoSynth',\n    name: 'Mono Synth',\n    props: ['polyphony', 'oscillatorType'],\n  },\n  // { id: 'noiseSynth', name: 'Noise Synth' }, // No sound, disabled for now\n  { id: 'pluckSynth', name: 'Pluck Synth', props: [] },\n  { id: 'sampler', name: 'Sampler', props: ['samples'] },\n  { id: 'synth', name: 'Synth', props: ['polyphony', 'oscillatorType'] },\n];\n\nexport const effects = [\n  // --------------------------------------------------------------------------\n  // Tone JS Effects\n  // --------------------------------------------------------------------------\n  { id: 'autoFilter', name: 'Auto Filter' },\n  { id: 'autoPanner', name: 'Auto Panner' },\n  { id: 'autoWah', name: 'Auto Wah' },\n  { id: 'bitCrusher', name: 'Bit Crusher' },\n  // { id: 'chorus', name: 'Chorus' },\n  { id: 'distortion', name: 'Distortion' },\n  { id: 'feedbackDelay', name: 'Feedback Delay' },\n  { id: 'freeverb', name: 'Freeverb' },\n  { id: 'panVol', name: 'Volume/Pan' },\n  // { id: 'reverb', name: 'Reverb' },\n  { id: 'tremolo', name: 'Tremolo' },\n  // --------------------------------------------------------------------------\n  // Tone JS Components\n  // --------------------------------------------------------------------------\n  { id: 'eq3', name: 'EQ3' },\n];\n\nconst config = {\n  instruments,\n  effects,\n};\n\nexport default config;\n","import PropTypes from 'prop-types';\nimport { instruments, effects } from '../config';\n\nexport const NoteType = PropTypes.shape({\n  name: PropTypes.string.isRequired,\n  duration: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n  velocity: PropTypes.number,\n  // pitch: PropTypes.string,\n  // octave: PropTypes.number,\n  // accidental: PropTypes.string,\n  // midi: PropTypes.number,\n});\n\nexport const StepNoteType = PropTypes.shape({\n  name: PropTypes.oneOfType([NoteType, PropTypes.string]),\n  duration: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n  velocity: PropTypes.number,\n});\n\nexport const StepType = PropTypes.oneOfType([\n  StepNoteType,\n  PropTypes.arrayOf(StepNoteType),\n  PropTypes.arrayOf(PropTypes.string),\n  PropTypes.string,\n]);\n\nexport const InstrumentTypes = PropTypes.oneOf(\n  instruments.map((effect) => effect.id),\n);\n\nexport const EffectTypes = PropTypes.oneOf(effects.map((effect) => effect.id));\n","import { StepNoteType, StepType } from 'components/Track';\n\nexport type SequencerStep = {\n  notes: StepNoteType[];\n  index: number;\n};\n\nexport default function buildSequencerStep(step: StepType, i): SequencerStep {\n  if (typeof step === 'string') {\n    return {\n      notes: [\n        {\n          name: step,\n        },\n      ],\n      index: i,\n    };\n  } else if (step && (step as StepNoteType).name) {\n    return {\n      notes: [\n        {\n          name: (step as StepNoteType).name,\n          duration: (step as StepNoteType).duration,\n          velocity: (step as StepNoteType).velocity,\n        },\n      ],\n      index: i,\n    };\n  } else if (Array.isArray(step)) {\n    return {\n      notes: step.map((s) => {\n        if (typeof s === 'string') {\n          return {\n            name: s,\n          };\n        }\n\n        return s;\n      }),\n      index: i,\n    };\n  }\n\n  return {\n    notes: [],\n    index: i,\n  };\n}\n","import { useRef, useEffect } from 'react';\n\nexport function usePrevious(value) {\n  // The ref object is a generic container whose current property is mutable ...\n  // ... and can hold any value, similar to an instance property on a class\n  const ref = useRef();\n\n  // Store current value in ref\n  useEffect(() => {\n    ref.current = value;\n  }, [value]); // Only re-run if value changes\n\n  // Return previous value (happens before update in useEffect above)\n  return ref.current;\n}\n","import React, { useState, useEffect, useRef } from 'react';\nimport PropTypes from 'prop-types';\nimport equal from 'fast-deep-equal';\n\nimport { SongContext } from './Song';\nimport { StepType } from '../types/propTypes';\nimport Tone from '../lib/tone';\nimport buildSequencerStep, { SequencerStep } from '../lib/buildSequencerStep';\nimport { usePrevious } from '../lib/hooks';\n\nexport type StepNoteType = {\n  name: string;\n  duration?: number;\n  velocity?: number;\n};\n\nexport type StepType = StepNoteType | StepNoteType[] | string;\n\nexport interface TrackProps {\n  steps?: StepType[];\n  volume?: number;\n  pan?: number;\n  mute?: boolean;\n  solo?: boolean;\n  subdivision?: string;\n  effects?: React.ReactNode[];\n  children: React.ReactNode;\n  onStepPlay?: (stepNotes: StepNoteType[], index: number) => void;\n}\n\nexport interface TrackConsumerProps extends TrackProps {\n  isPlaying: boolean;\n}\n\nexport const TrackContext = React.createContext({\n  volume: 0,\n  pan: 0,\n  mute: false,\n  solo: false,\n  effectsChain: null,\n  onInstrumentsUpdate: null,\n  onAddToEffectsChain: null,\n  onRemoveFromEffectsChain: null,\n});\n\nconst TrackConsumer: React.FC<TrackConsumerProps> = ({\n  // <Song /> props\n  isPlaying,\n  // <Track /> props\n  steps = [],\n  volume = 0,\n  pan = 0,\n  mute,\n  solo,\n  subdivision = '4n',\n  effects = [],\n  children,\n  onStepPlay,\n}) => {\n  const [effectsChain, setEffectsChain] = useState([]);\n  const [instruments, setInstruments] = useState([]);\n  const sequencer = useRef<{\n    start: Function;\n    stop: Function;\n    remove: Function;\n    add: Function;\n    dispose: Function;\n  }>();\n  const instrumentsRef = useRef(instruments);\n\n  useEffect(() => {\n    instrumentsRef.current = instruments;\n  }, [instruments]);\n\n  /*\n  Tone.Sequence can't easily play chords. By default, arrays within steps are flattened out and subdivided. However an array of notes is our preferred way of representing chords. To get around this, buildSequencerStep() will transform notes and put them in a notes field as an array. We can then loop through and run triggerAttackRelease() to play the note/s.\n  */\n  const sequencerSteps = steps.map(buildSequencerStep);\n  const prevSequencerSteps: SequencerStep[] = usePrevious(sequencerSteps);\n\n  useEffect(() => {\n    // -------------------------------------------------------------------------\n    // STEPS\n    // -------------------------------------------------------------------------\n\n    // Start/Stop sequencer!\n    if (isPlaying) {\n      sequencer.current = new Tone.Sequence(\n        (_, step) => {\n          step.notes.forEach((note) => {\n            instrumentsRef.current.map((instrument) => {\n              instrument.triggerAttackRelease(\n                note.name,\n                note.duration || 0.5,\n                undefined,\n                note.velocity,\n              );\n            });\n          });\n\n          if (typeof onStepPlay === 'function') {\n            onStepPlay(step.notes, step.index);\n          }\n        },\n        sequencerSteps,\n        subdivision,\n      );\n\n      sequencer.current?.start(0);\n    } else {\n      if (sequencer.current) {\n        sequencer.current.stop();\n      }\n    }\n  }, [isPlaying]);\n\n  useEffect(() => {\n    if (sequencer.current) {\n      // const isEqual = equal(steps.notes, prevSequencerSteps[i].notes);\n      sequencerSteps.forEach((step, i) => {\n        const isEqual = equal(\n          sequencerSteps[i].notes,\n          prevSequencerSteps && prevSequencerSteps[i]\n            ? prevSequencerSteps[i].notes\n            : [],\n        );\n\n        if (!isEqual) {\n          sequencer.current?.remove(i);\n          sequencer.current?.add(i, step);\n        }\n      });\n    }\n  }, [JSON.stringify(sequencerSteps)]);\n\n  useEffect(() => {\n    return function cleanup() {\n      if (sequencer.current) {\n        sequencer.current.dispose();\n      }\n    };\n  }, []);\n\n  const handleAddToEffectsChain = (effect) => {\n    // console.log('<Track />', 'onAddToEffectsChain');\n\n    setEffectsChain((prevEffectsChain) => {\n      return [effect, ...prevEffectsChain];\n    });\n  };\n\n  const handleRemoveFromEffectsChain = (effect) => {\n    // console.log('<Track />', 'onRemoveFromEffectsChain', effect);\n\n    setEffectsChain((prevEffectsChain) => {\n      return prevEffectsChain.filter((e) => e.id !== effect.id);\n    });\n  };\n\n  const handleInstrumentsUpdate = (newInstruments) => {\n    setInstruments(newInstruments);\n  };\n\n  return (\n    <TrackContext.Provider\n      value={{\n        effectsChain, // Used by Instrument\n        pan,\n        volume,\n        mute,\n        solo,\n        onInstrumentsUpdate: handleInstrumentsUpdate,\n        onAddToEffectsChain: handleAddToEffectsChain,\n        onRemoveFromEffectsChain: handleRemoveFromEffectsChain,\n      }}\n    >\n      {children}\n      {effects}\n    </TrackContext.Provider>\n  );\n};\n\nTrackConsumer.propTypes = {\n  // <Song /> props\n  isPlaying: PropTypes.bool,\n  // <Track /> props\n  // @ts-ignore\n  steps: PropTypes.arrayOf(StepType),\n  volume: PropTypes.number,\n  pan: PropTypes.number,\n  mute: PropTypes.bool,\n  solo: PropTypes.bool,\n  subdivision: PropTypes.string, // react-music = resolution\n  // effects: PropTypes.oneOfType([\n  //   PropTypes.node,\n  //   PropTypes.arrayOf(PropTypes.element),\n  // ]),\n  onStepPlay: PropTypes.func,\n};\n\nconst Track: React.FC<TrackProps> = (props) => {\n  const { isPlaying } = React.useContext(SongContext);\n\n  if (typeof window === 'undefined') {\n    return null;\n  }\n\n  return <TrackConsumer isPlaying={isPlaying} {...props} />;\n};\n\nexport default Track;\n","import React, {\n  useEffect,\n  useRef,\n  useContext,\n  // useLayoutEffect\n} from 'react';\nimport PropTypes from 'prop-types';\n\n// import { SongContext } from './Song';\nimport { TrackContext } from './Track';\nimport {\n  NoteType as PropTypeNoteType,\n  InstrumentTypes,\n} from '../types/propTypes';\nimport Tone from '../lib/tone';\nimport { usePrevious } from '../lib/hooks';\n\ntype NoteType = {\n  name: string;\n  velocity?: number;\n  duration?: number | string;\n  /** Use unique key to differentiate from same notes, otherwise it won't play */\n  key?: string | number;\n};\n\nexport type InstrumentType =\n  | 'amSynth'\n  | 'duoSynth'\n  | 'fmSynth'\n  | 'membraneSynth'\n  | 'metalSynth'\n  | 'monoSynth'\n  | 'noiseSynth'\n  | 'pluckSynth'\n  | 'synth'\n  | 'sampler';\n\nexport interface InstrumentProps {\n  type: InstrumentType;\n  notes?: NoteType[];\n  /** Should deprecate */\n  options?: any;\n  polyphony?: number;\n  oscillator?: {\n    type: 'triangle' | 'sine' | 'square';\n  };\n  envelope?: {\n    attack?: number;\n    decay?: number;\n    sustain?: number;\n    release?: number;\n  };\n  samples?: {\n    [k: string]: string;\n  };\n  mute?: boolean;\n  solo?: boolean;\n  onLoad?: Function;\n}\n\ninterface InstrumentConsumerProps extends InstrumentProps {\n  volume?: number;\n  pan?: number;\n  effectsChain?: React.ReactNode[];\n  onInstrumentsUpdate?: Function;\n}\n\nconst InstrumentConsumer: React.FC<InstrumentConsumerProps> = ({\n  // <Instrument /> Props\n  type = 'synth',\n  options,\n  polyphony = 4,\n  oscillator,\n  envelope,\n  notes = [],\n  samples,\n  onLoad,\n  // <Track /> Props\n  volume,\n  pan,\n  mute,\n  solo,\n  effectsChain,\n  onInstrumentsUpdate,\n}) => {\n  const instrumentRef = useRef<\n    Partial<{\n      curve: number;\n      release: number;\n      triggerAttack: Function;\n      triggerAttackRelease: Function;\n      triggerRelease: Function;\n      add: Function;\n      set: Function;\n      chain: Function;\n      dispose: Function;\n      disconnect: Function;\n    }>\n  >();\n  // const trackChannelBase = useRef(new Tone.PanVol(pan, volume));\n  // const trackChannelBase = useRef(new Tone.Channel(volume, pan));\n  const trackChannelBase = useRef(null);\n  const prevNotes: any[] = usePrevious(notes);\n\n  // -------------------------------------------------------------------------\n  // CHANNEL\n  // TODO: Consider moving this to <Track>\n  // -------------------------------------------------------------------------\n\n  useEffect(() => {\n    trackChannelBase.current = new Tone.Channel(volume, pan);\n\n    return function cleanup() {\n      if (trackChannelBase.current) {\n        trackChannelBase.current.dispose();\n      }\n    };\n  }, []);\n\n  // -------------------------------------------------------------------------\n  // INSTRUMENT TYPE\n  // -------------------------------------------------------------------------\n\n  useEffect(() => {\n    if (type === 'sampler') {\n      instrumentRef.current = new Tone.Sampler(samples, onLoad);\n\n      if (options && options.curve) {\n        instrumentRef.current.curve = options.curve;\n      }\n\n      if (options && options.release) {\n        instrumentRef.current.release = options.release;\n      }\n    } else if (type === 'membraneSynth') {\n      instrumentRef.current = new Tone.MembraneSynth(\n        buildSynthOptions({\n          oscillator,\n          envelope,\n        }),\n      );\n    } else if (type === 'metalSynth') {\n      instrumentRef.current = new Tone.MetalSynth();\n    } else if (type === 'noiseSynth') {\n      instrumentRef.current = new Tone.NoiseSynth();\n    } else if (type === 'pluckSynth') {\n      instrumentRef.current = new Tone.PluckSynth();\n    } else {\n      let synth;\n\n      if (type === 'amSynth') {\n        synth = Tone.AMSynth;\n      } else if (type === 'duoSynth') {\n        synth = Tone.DuoSynth;\n      } else if (type === 'fmSynth') {\n        synth = Tone.FMSynth;\n      } else if (type === 'monoSynth') {\n        synth = Tone.MonoSynth;\n      } else if (type === 'synth') {\n        synth = Tone.Synth;\n      } else {\n        synth = Tone.Synth;\n      }\n\n      /**\n       * PolySynth accepts other Synth types as second param, making them\n       * polyphonic. As this is a common use case, all Synths will be created\n       * via PolySynth. Monophonic synths can easily be created by setting the\n       * `polyphony` prop to 1.\n       */\n      instrumentRef.current = new Tone.PolySynth(\n        polyphony,\n        synth,\n        buildSynthOptions({\n          oscillator,\n          envelope,\n        }),\n      );\n    }\n\n    instrumentRef.current.chain(\n      ...effectsChain,\n      trackChannelBase.current,\n      Tone.Master,\n    );\n\n    // Add this Instrument to Track Context\n    onInstrumentsUpdate([instrumentRef.current]);\n\n    return function cleanup() {\n      if (instrumentRef.current) {\n        instrumentRef.current.dispose();\n      }\n    };\n  }, [type, polyphony]);\n\n  useEffect(() => {\n    if (\n      // TODO: Add other synth types\n      type === 'synth' &&\n      instrumentRef &&\n      instrumentRef.current &&\n      oscillator\n    ) {\n      instrumentRef.current.set('oscillator', oscillator);\n      // console.log(oscillator);\n    }\n  }, [oscillator, type]);\n\n  // -------------------------------------------------------------------------\n  // VOLUME / PAN / MUTE / SOLO\n  // -------------------------------------------------------------------------\n\n  useEffect(() => {\n    trackChannelBase.current.volume.value = volume;\n  }, [volume]);\n\n  useEffect(() => {\n    trackChannelBase.current.pan.value = pan;\n  }, [pan]);\n\n  useEffect(() => {\n    trackChannelBase.current.mute = mute;\n  }, [mute]);\n\n  useEffect(() => {\n    trackChannelBase.current.solo = solo;\n  }, [solo]);\n\n  // -------------------------------------------------------------------------\n  // NOTES\n  // -------------------------------------------------------------------------\n\n  /**\n   NOTE: Would prefer to use useLayoutEffect as it is a little faster, but unable to test it right now\n   **/\n  useEffect(() => {\n    // Loop through all current notes\n    notes &&\n      notes.forEach((note) => {\n        // Check if note is playing\n        const isPlaying =\n          prevNotes &&\n          prevNotes.filter((prevNote) => {\n            // Check both note name and unique key.\n            // Key helps differentiate same notes, otherwise it won't trigger\n            return prevNote.name === note.name && prevNote.key === note.key;\n          }).length > 0;\n\n        // Only play note is it isn't already playing\n        if (!isPlaying) {\n          if (note.duration) {\n            instrumentRef.current.triggerAttackRelease(\n              note.name,\n              note.duration,\n              undefined,\n              note.velocity,\n            );\n          } else {\n            instrumentRef.current.triggerAttack(\n              note.name,\n              undefined,\n              note.velocity,\n            );\n          }\n        }\n      });\n\n    // Loop through all previous notes\n    prevNotes &&\n      prevNotes.forEach((note) => {\n        // Check if note is still playing\n        const isPlaying =\n          notes && notes.filter((n) => n.name === note.name).length > 0;\n\n        if (!isPlaying) {\n          instrumentRef.current.triggerRelease(note.name);\n        }\n      });\n  }, [notes, prevNotes]);\n\n  // -------------------------------------------------------------------------\n  // EFFECTS CHAIN\n  // -------------------------------------------------------------------------\n\n  useEffect(() => {\n    // NOTE: Using trackChannelBase causes effects to not turn off\n    instrumentRef.current.disconnect();\n    instrumentRef.current.chain(\n      ...effectsChain,\n      trackChannelBase.current,\n      Tone.Master,\n    );\n  }, [effectsChain]);\n\n  // -------------------------------------------------------------------------\n  // SAMPLES\n  // Run whenever `samples` change, using Tone.Sampler's `add` method to load\n  // more samples after initial mount\n  // -------------------------------------------------------------------------\n\n  useEffect(() => {\n    if (\n      type === 'sampler' &&\n      typeof onLoad === 'function' &&\n      Boolean(samples)\n    ) {\n      // Create an array of promises from `samples`\n      const loadSamplePromises = Object.keys(samples).map((key) => {\n        return new Promise((resolve) => {\n          const sample = samples[key];\n\n          // Pass `resolve` to `onLoad` parameter of Tone.Sampler\n          // When sample loads, this promise will resolve\n          instrumentRef.current.add(key, sample, resolve);\n        });\n      });\n\n      // Once all promises in array resolve, run onLoad callback\n      Promise.all(loadSamplePromises).then((event) => {\n        onLoad(event);\n      });\n    }\n  }, [samples, type]);\n\n  return null;\n};\n\nInstrumentConsumer.propTypes = {\n  // <Instrument /> Props\n  // @ts-ignore\n  type: InstrumentTypes.isRequired,\n  options: PropTypes.object,\n  // @ts-ignore\n  notes: PropTypes.arrayOf(PropTypeNoteType), // Currently played notes.\n  polyphony: PropTypes.number,\n  envelope: PropTypes.shape({\n    attack: PropTypes.number,\n    decay: PropTypes.number,\n    sustain: PropTypes.number,\n    release: PropTypes.number,\n  }),\n  // oscillator: PropTypes.shape({\n  //   type: PropTypes.oneOf(['triangle', 'sine', 'square']),\n  // }),\n  // @ts-ignore\n  samples: PropTypes.object,\n  // trackChannel: PropTypes.object, // An instance of new this.Tone.PanVol()\n  // <Track /> Props\n  volume: PropTypes.number,\n  pan: PropTypes.number,\n  mute: PropTypes.bool,\n  solo: PropTypes.bool,\n  effectsChain: PropTypes.array,\n  onInstrumentsUpdate: PropTypes.func,\n};\n\nconst Instrument: React.FC<InstrumentProps> = ({\n  type,\n  options,\n  notes,\n  polyphony,\n  oscillator,\n  envelope,\n  samples,\n  onLoad,\n}) => {\n  const {\n    volume,\n    pan,\n    mute,\n    solo,\n    effectsChain,\n    onInstrumentsUpdate,\n  } = useContext(TrackContext);\n\n  if (typeof window === 'undefined') {\n    return null;\n  }\n\n  return (\n    <InstrumentConsumer\n      // <Instrument /> Props\n      type={type}\n      options={options}\n      notes={notes}\n      polyphony={polyphony}\n      oscillator={oscillator}\n      envelope={envelope}\n      samples={samples}\n      onLoad={onLoad}\n      // <Track /> Props\n      volume={volume}\n      pan={pan}\n      mute={mute}\n      solo={solo}\n      effectsChain={effectsChain}\n      onInstrumentsUpdate={onInstrumentsUpdate}\n    />\n  );\n};\n\n/**\n * Use Instrument's flattened synth props to create options object for Tone JS\n */\nconst buildSynthOptions = ({ oscillator, envelope }) => {\n  if (oscillator || envelope) {\n    return {\n      ...(envelope ? { envelope } : {}),\n      ...(oscillator ? { oscillator } : {}),\n    };\n  }\n\n  return undefined;\n};\n\nexport default Instrument;\n","import React, { useEffect, useContext, useRef } from 'react';\nimport PropTypes from 'prop-types';\n\nimport { TrackContext } from './Track';\nimport Tone from '../lib/tone';\nimport { EffectTypes } from '../types/propTypes';\n\nexport type EffectType =\n  | 'autoFilter'\n  | 'autoPanner'\n  | 'autoWah'\n  | 'bitCrusher'\n  | 'distortion'\n  | 'feedbackDelay'\n  | 'freeverb'\n  | 'panVol'\n  | 'tremolo'\n  | 'eq3';\n\nexport interface EffectProps {\n  type?: EffectType;\n  id?: string;\n  delayTime?: string;\n  feedback?: number;\n  wet?: number;\n  low?: number;\n  mid?: number;\n  high?: number;\n  lowFrequency?: number;\n  highFrequency?: number;\n}\n\nexport interface EffectConsumerProps extends EffectProps {\n  onAddToEffectsChain?: Function;\n  onRemoveFromEffectsChain?: Function;\n}\n\nconst EffectConsumer: React.FC<EffectConsumerProps> = ({\n  type,\n  id,\n  delayTime = '8n',\n  feedback = 0.5,\n  wet = 1,\n  low,\n  mid,\n  high,\n  lowFrequency,\n  highFrequency,\n  onAddToEffectsChain,\n  onRemoveFromEffectsChain,\n}) => {\n  const effect = useRef<{\n    id: string | number;\n    feedback?: {\n      value: number;\n    };\n    delay?: {\n      value: number;\n    };\n    delayTime?: {\n      value: string;\n    };\n    wet?: {\n      value: number;\n    };\n    low?: {\n      value: number;\n    };\n    mid?: {\n      value: number;\n    };\n    high?: {\n      value: number;\n    };\n    lowFrequency?: {\n      value: number;\n    };\n    highFrequency?: {\n      value: number;\n    };\n  }>();\n\n  useEffect(() => {\n    // console.log('<Effect /> mount');\n    // console.log(`id: ${id}`);\n\n    if (type === 'autoFilter') {\n      effect.current = new Tone.AutoFilter();\n    } else if (type === 'autoPanner') {\n      effect.current = new Tone.AutoPanner();\n    } else if (type === 'autoWah') {\n      effect.current = new Tone.AutoWah();\n    } else if (type === 'bitCrusher') {\n      effect.current = new Tone.BitCrusher();\n      // Removed for now because delayTime has to be in ms\n      // } else if (type === 'chorus') {\n      //   effect.current = new Tone.Chorus();\n    } else if (type === 'distortion') {\n      effect.current = new Tone.Distortion(0.5);\n    } else if (type === 'feedbackDelay') {\n      effect.current = new Tone.FeedbackDelay(delayTime, feedback);\n    } else if (type === 'freeverb') {\n      effect.current = new Tone.Freeverb();\n    } else if (type === 'panVol') {\n      effect.current = new Tone.PanVol();\n      // Needs generate()\n      // } else if (type === 'reverb') {\n      //   effect.current = new Tone.Reverb();\n    } else if (type === 'tremolo') {\n      effect.current = new Tone.Tremolo();\n    } else if (type === 'eq3') {\n      effect.current = new Tone.EQ3(low, mid, high);\n    }\n\n    if (effect.current) {\n      effect.current.id = id;\n\n      // Update effects chain\n      // TODO: Work out which index to insert current this.effect\n      onAddToEffectsChain(effect.current);\n    }\n\n    return () => {\n      // console.log('<Effect /> unmount');\n      onRemoveFromEffectsChain(effect.current);\n    };\n  }, [type]);\n\n  useEffect(() => {\n    if (effect.current && effect.current.feedback) {\n      effect.current.feedback.value = feedback;\n    }\n  }, [feedback]);\n\n  useEffect(() => {\n    if (effect.current && effect.current.delayTime) {\n      effect.current.delayTime.value = delayTime;\n    }\n  }, [delayTime]);\n\n  useEffect(() => {\n    if (effect.current && effect.current.wet) {\n      effect.current.wet.value = wet;\n    }\n  }, [wet]);\n\n  useEffect(() => {\n    if (typeof low !== 'undefined' && effect.current && effect.current.low) {\n      effect.current.low.value = low;\n    }\n  }, [low]);\n\n  useEffect(() => {\n    if (typeof mid !== 'undefined' && effect.current && effect.current.mid) {\n      effect.current.mid.value = mid;\n    }\n  }, [mid]);\n\n  useEffect(() => {\n    if (typeof high !== 'undefined' && effect.current && effect.current.high) {\n      effect.current.high.value = high;\n    }\n  }, [high]);\n\n  useEffect(() => {\n    if (\n      typeof lowFrequency !== 'undefined' &&\n      effect.current &&\n      effect.current.lowFrequency\n    ) {\n      effect.current.lowFrequency.value = lowFrequency;\n    }\n  }, [lowFrequency]);\n\n  useEffect(() => {\n    if (\n      typeof highFrequency !== 'undefined' &&\n      effect.current &&\n      effect.current.highFrequency\n    ) {\n      effect.current.highFrequency.value = highFrequency;\n    }\n  }, [highFrequency]);\n\n  return null;\n};\n\nEffectConsumer.propTypes = {\n  // @ts-ignore\n  type: EffectTypes.isRequired,\n  // @ts-ignore\n  id: PropTypes.oneOfType([\n    PropTypes.string.isRequired,\n    PropTypes.number.isRequired,\n  ]),\n  delayTime: PropTypes.string,\n  feedback: PropTypes.number,\n  wet: PropTypes.number,\n  low: PropTypes.number,\n  mid: PropTypes.number,\n  high: PropTypes.number,\n  lowFrequency: PropTypes.number,\n  highFrequency: PropTypes.number,\n  // <Track /> Props\n  onAddToEffectsChain: PropTypes.func,\n  onRemoveFromEffectsChain: PropTypes.func,\n};\n\nconst Effect: React.FC<EffectProps> = (props) => {\n  const { onAddToEffectsChain, onRemoveFromEffectsChain } = useContext(\n    TrackContext,\n  );\n\n  return (\n    <EffectConsumer\n      onAddToEffectsChain={onAddToEffectsChain}\n      onRemoveFromEffectsChain={onRemoveFromEffectsChain}\n      {...props}\n    />\n  );\n};\n\nexport default Effect;\n"]},"metadata":{},"sourceType":"module"}